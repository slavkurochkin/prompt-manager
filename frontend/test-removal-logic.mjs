// Test script to verify item removal logic in RequirementsConstructor
// This tests the mergeAutoGeneratedContent function behavior

function isAutoGenerated(item) {
  const key = item.split(':')[0]?.trim();
  return key && (
    item.includes('Framework:') ||
    item.includes('Database:') ||
    item.includes('Database Migrations:') ||
    item.includes('Vector Database:') ||
    item.includes('Messaging:') ||
    item.includes('Caching Strategy:') ||
    item.includes('Gateway:') ||
    item.includes('Contracts:') ||
    item.includes('Testing:') ||
    item.includes('Environment:') ||
    item.includes('Observability:') ||
    item.includes('Security Defaults:') ||
    item.includes('Failure First Thinking:') ||
    item.includes('Testing Philosophy:') ||
    item.includes('Model Validation:') ||
    item.includes('Design Style:') ||
    item.includes('Icon Library:') ||
    item.includes('UI Framework:') ||
    item.includes('Chart Library:')
  );
}

function mergeSection(existingItems, newItems) {
  const existingItemMap = new Map();
  const customItems = [];
  
  // Separate auto-generated from custom items
  existingItems.forEach(item => {
    const key = item.split(':')[0]?.trim();
    if (isAutoGenerated(item) && key) {
      existingItemMap.set(key, item);
    } else {
      customItems.push(item);
    }
  });
  
  // Identify which items should remain (those in the new auto-generated prompt)
  const newItemKeys = new Set();
  newItems.forEach(item => {
    const key = item.split(':')[0]?.trim();
    if (key) {
      newItemKeys.add(key);
    }
  });
  
  // Remove auto-generated items that are no longer in the new prompt
  const keysToRemove = [];
  existingItemMap.forEach((value, key) => {
    if (!newItemKeys.has(key)) {
      keysToRemove.push(key);
    }
  });
  keysToRemove.forEach(key => existingItemMap.delete(key));
  
  // Add/update items from new content
  newItems.forEach(item => {
    const key = item.split(':')[0]?.trim();
    if (key) {
      existingItemMap.set(key, item);
    }
  });
  
  return [...Array.from(existingItemMap.values()), ...customItems].filter(Boolean);
}

// Test Case 1: Remove Frontend Framework
console.log('Test 1: Remove Frontend Framework');
const existing1 = [
  'Frontend Framework: React',
  'Backend Framework: Node.js/Express',
  'Database: PostgreSQL'
];
const new1 = [
  'Backend Framework: Node.js/Express',
  'Database: PostgreSQL'
];
const result1 = mergeSection(existing1, new1);
console.log('Existing:', existing1);
console.log('New:', new1);
console.log('Result:', result1);
console.log('Expected: Frontend Framework should be removed');
console.log('Pass:', !result1.some(item => item.includes('Frontend Framework:')));
console.log('');

// Test Case 2: Remove multiple items
console.log('Test 2: Remove multiple items');
const existing2 = [
  'Frontend Framework: React',
  'Backend Framework: Node.js/Express',
  'Database: PostgreSQL',
  'Messaging: RabbitMQ'
];
const new2 = [
  'Backend Framework: Node.js/Express'
];
const result2 = mergeSection(existing2, new2);
console.log('Existing:', existing2);
console.log('New:', new2);
console.log('Result:', result2);
console.log('Expected: Only Backend Framework should remain');
console.log('Pass:', result2.length === 1 && result2[0].includes('Backend Framework:'));
console.log('');

// Test Case 3: Preserve custom items
console.log('Test 3: Preserve custom items');
const existing3 = [
  'Frontend Framework: React',
  'Backend Framework: Node.js/Express',
  'Custom requirement: Use TypeScript',
  'Another custom note'
];
const new3 = [
  'Backend Framework: Node.js/Express'
];
const result3 = mergeSection(existing3, new3);
console.log('Existing:', existing3);
console.log('New:', new3);
console.log('Result:', result3);
console.log('Expected: Backend Framework + 2 custom items');
const hasBackend = result3.some(item => item.includes('Backend Framework:'));
const hasCustom1 = result3.some(item => item.includes('Custom requirement'));
const hasCustom2 = result3.some(item => item.includes('Another custom note'));
const noFrontend = !result3.some(item => item.includes('Frontend Framework:'));
console.log('Pass:', hasBackend && hasCustom1 && hasCustom2 && noFrontend && result3.length === 3);
console.log('');

// Test Case 4: Update existing item
console.log('Test 4: Update existing item');
const existing4 = [
  'Frontend Framework: React',
  'Backend Framework: Node.js/Express'
];
const new4 = [
  'Frontend Framework: Vue',
  'Backend Framework: Node.js/Express'
];
const result4 = mergeSection(existing4, new4);
console.log('Existing:', existing4);
console.log('New:', new4);
console.log('Result:', result4);
const hasVue = result4.some(item => item.includes('Frontend Framework: Vue'));
const noReact = !result4.some(item => item.includes('Frontend Framework: React'));
console.log('Expected: Frontend Framework should be updated to Vue');
console.log('Pass:', hasVue && noReact);
console.log('');

// Test Case 5: Add new item
console.log('Test 5: Add new item');
const existing5 = [
  'Frontend Framework: React'
];
const new5 = [
  'Frontend Framework: React',
  'Database: PostgreSQL'
];
const result5 = mergeSection(existing5, new5);
console.log('Existing:', existing5);
console.log('New:', new5);
console.log('Result:', result5);
const hasReact = result5.some(item => item.includes('Frontend Framework: React'));
const hasPostgres = result5.some(item => item.includes('Database: PostgreSQL'));
console.log('Expected: Both items should be present');
console.log('Pass:', hasReact && hasPostgres && result5.length === 2);
console.log('');

console.log('All tests completed!');


